{% extends "cba_app/base.html" %}

{% block body_class %}page-step page-step1{% endblock %}

{% block content %}
    <section class="content pt-3">
        <div class="container-fluid">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex flex-column">
                        <div class="text-muted text-uppercase text-sm">CBA · Paso 1</div>
                        <h3 class="m-0">Identificación de alternativas</h3>
                        <div class="text-muted text-sm mt-2">En este paso se listan y definen todas las alternativas (postores) que se van a comparar con CBA.</div>
                    </div>
                    <div class="mt-2">
                        {% include "cba_app/_step_progress.html" with current=1 total=10 percent=10 %}
                    </div>
                </div>

                <div class="card-body">

        {% include "cba_app/_cba_context_bar.html" with show_edit=1 %}

        <section class="assistant" aria-label="Asistente IA">
            <div class="assistant__head">
                <div class="assistant__meta">
                    <div class="assistant__title">Asistente SIDEO IA</div>
                    <div class="assistant__subtitle">Revisa tus alternativas y te devuelve observaciones claras.</div>
                </div>
                <div class="assistant__actions">
                    <button type="button" class="btn btn-primary btn-sm" id="aiAltAuditBtn">Revisar postores</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="aiAltAuditClearBtn">Limpiar</button>
                </div>
            </div>

            <div id="aiAltAuditStatus" class="cba-ai__status text-muted" style="display:none;"></div>

            <div class="assistant__body">
                <div id="aiAltAuditPlaceholder" class="assistant__placeholder">Aquí aparecerá la respuesta del asistente.</div>
                <pre id="aiAltAuditOutput" class="cba-ai__output" aria-label="Respuesta del asistente IA"></pre>
            </div>
        </section>

        <div class="table-wrapper table-wrapper--step mt-3">
            <div class="step-section-head">
                <div class="step-section-title">Postores (alternativas)</div>
            </div>

            <form method="post" class="form-inline form-inline--step">
                {% csrf_token %}
                {{ form.name.label_tag }}
                {{ form.name }}
                <button type="submit" class="icon-button icon-button-add" title="Agregar postor">+</button>
            </form>

            <div class="table-responsive">
            <table class="table table-bordered table-striped table-sm mb-0">
                <tr>
                    <th>#</th>
                    <th>Nombre</th>
                    <th style="width:80px; text-align:center;">Acciones</th>
                </tr>
                {% for alt in alternatives %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                        {% if editing_alt and editing_alt.id == alt.id %}
                            <form method="post" class="form-inline form-inline--step" style="gap:6px;">
                                {% csrf_token %}
                                <input type="hidden" name="update_id" value="{{ alt.id }}">
                                <input type="text" name="name" value="{{ alt.name }}" class="form-control form-control-sm" autocomplete="off" />
                                <button type="submit" class="icon-button icon-button-edit" title="Guardar cambios">&#10003;</button>
                                <a href="{% url 'cba_step1' %}" class="icon-button icon-button-delete" title="Cancelar">&times;</a>
                            </form>
                        {% else %}
                            {{ alt.name }}
                        {% endif %}
                    </td>
                    <td style="text-align:center; white-space:nowrap;">
                        {% if not editing_alt or editing_alt.id != alt.id %}
                            <a href="{% url 'cba_step1' %}?edit={{ alt.id }}" class="icon-button icon-button-edit" title="Editar">&#9998;</a>
                        {% endif %}
                        <form method="post" style="display:inline;">
                            {% csrf_token %}
                            <input type="hidden" name="delete_id" value="{{ alt.id }}">
                            <button type="submit" class="icon-button icon-button-delete" title="Eliminar">&times;</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3">No hay postores/alternativas registradas aún.</td>
                </tr>
                {% endfor %}
            </table>
            </div>

            <div class="step-nav">
                <div></div>
                <a href="{% url 'cba_step2' %}" class="btn btn-primary nav-next">Siguiente &rsaquo;</a>
            </div>
        </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function renderAIMarkup(text) {
            let safe = escapeHtml(text || '');
            safe = safe.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            return safe;
        }

        (function initAltAudit(){
            const STORAGE_KEY = 'cba_step1_ai_postores_v1';
            const btn = document.getElementById('aiAltAuditBtn');
            const clearBtn = document.getElementById('aiAltAuditClearBtn');
            const out = document.getElementById('aiAltAuditOutput');
            const status = document.getElementById('aiAltAuditStatus');
            const placeholder = document.getElementById('aiAltAuditPlaceholder');
            if (!btn || !out) return;

            out.textContent = '';
            if (placeholder) placeholder.style.display = 'block';

            // Restaurar último texto al volver a la página
            try {
                const cached = window.localStorage.getItem(STORAGE_KEY);
                if (cached) {
                    out.innerHTML = cached;
                    if (placeholder) placeholder.style.display = 'none';
                    if (status) {
                        status.style.display = 'block';
                        status.textContent = 'Última revisión cargada.';
                    }
                }
            } catch (e) {
                // no-op
            }

            // Limpiar cache cuando se cambian postores (agregar/editar/eliminar)
            document.querySelectorAll('form').forEach((formEl) => {
                formEl.addEventListener('submit', () => {
                    try { window.localStorage.removeItem(STORAGE_KEY); } catch (e) {}
                });
            });

            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    out.textContent = '';
                    if (placeholder) placeholder.style.display = 'block';
                    if (status) {
                        status.style.display = 'block';
                        status.textContent = 'Limpio.';
                    }
                    try { window.localStorage.removeItem(STORAGE_KEY); } catch (e) {}
                });
            }

            btn.addEventListener('click', async () => {
                btn.disabled = true;
                if (status) {
                    status.style.display = 'block';
                    status.textContent = 'Revisando alternativas...';
                }
                if (placeholder) placeholder.style.display = 'none';
                out.textContent = '';

                try {
                    const resp = await fetch("{% url 'cba_ai_alternatives_audit' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({})
                    });
                    const data = await resp.json();
                    if (!data.ok) {
                        throw new Error(data.error || 'No se pudo auditar alternativas.');
                    }
                    out.innerHTML = renderAIMarkup(data.content || '');
                    try { window.localStorage.setItem(STORAGE_KEY, out.innerHTML); } catch (e) {}
                    if (status) status.textContent = 'Listo.';
                } catch (e) {
                    out.textContent = '';
                    if (placeholder) placeholder.style.display = 'block';
                    if (status) status.textContent = (e && e.message) ? e.message : 'Error auditando alternativas.';
                } finally {
                    btn.disabled = false;
                }
            });
        })();
    </script>
{% endblock %}

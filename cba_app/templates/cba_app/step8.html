{% extends "cba_app/base.html" %}

{% block body_class %}page-step page-step8{% endblock %}

{% block content %}
    <section class="content pt-3">
        <div class="container-fluid">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex flex-column">
                        <div class="text-muted text-uppercase text-sm">CBA · Paso 8</div>
                        <h3 class="m-0">Importancia de cada ventaja</h3>
                        <div class="text-muted text-sm mt-2">Asigna un puntaje de importancia solo donde exista la mayor ventaja (base: Paso 6).</div>
                    </div>
                    <div class="mt-2">
                        {% include "cba_app/_step_progress.html" with current=8 total=10 percent=80 %}
                    </div>
                </div>

                <div class="card-body">

    {% include "cba_app/_cba_context_bar.html" %}

    <p class="text-muted">
        En este paso, tomando como referencia la matriz del <strong>Paso 6</strong>, solo las celdas
        donde un postor tiene la <strong>mayor ventaja</strong> en un factor quedan habilitadas para asignar
        un número de importancia (por ejemplo: 100, 90, 70, ...).
    </p>

    <div class="mt-3">
        <div class="cba-ai__actions">
            <button type="button" class="btn btn-primary btn-sm" id="aiSuggestScoresBtn">Sugerir puntajes (IA)</button>
            <button type="button" class="btn btn-outline-secondary btn-sm ml-2" id="aiAuditScoresBtn">Detectar inconsistencias (IA)</button>
        </div>
        <div class="cba-ai__status" id="aiSuggestScoresStatus" style="display:none; margin-top:8px;"></div>
        <pre class="cba-ai__output" id="aiSuggestScoresOutput" style="display:none;"></pre>
    </div>

    <form method="post" class="mt-3">
        {% csrf_token %}

        <div class="table-wrapper table-wrapper--step" style="margin-top:16px;">
        <div class="table-responsive">
        <table class="table table-bordered table-striped table-sm mb-0">
            <tr>
                <th>FACTORES</th>
                {% for alt in alternatives %}
                    <th>{{ alt.name }}</th>
                {% endfor %}
            </tr>

            {% for row in rows %}
            <tr>
                <td>{{ row.criterion.name }}</td>
                {% for cell in row.cells %}
                <td>
                    {% if cell.has_advantage %}
                        <input type="number" class="form-control form-control-sm" name="{{ cell.name }}" value="{{ cell.value }}" min="0">
                    {% else %}
                        <!-- Sin ventaja principal: celda bloqueada -->
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="{{ alternatives|length|add:'1' }}">No hay ventajas disponibles desde el Paso 6.</td>
            </tr>
            {% endfor %}
        </table>
        </div>
        </div>

        <div class="step-nav">
            <a href="{% url 'cba_step7' %}" class="btn btn-outline-secondary nav-prev">&larr; Paso anterior</a>
            <button type="submit" class="btn btn-primary nav-next">Siguiente &rsaquo;</button>
        </div>
    </form>

                </div>
            </div>
        </div>
    </section>

{% endblock %}

{% block extra_js %}
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function renderAIMarkup(text) {
            let safe = escapeHtml(text || '');
            safe = safe.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            return safe;
        }

        (function initAISuggestScores(){
            const AUDIT_STORAGE_KEY = 'cba_step8_ai_puntajes_v1';
            const btn = document.getElementById('aiSuggestScoresBtn');
            const out = document.getElementById('aiSuggestScoresOutput');
            const status = document.getElementById('aiSuggestScoresStatus');
            if (!btn || !out) return;

            btn.addEventListener('click', async () => {
                btn.disabled = true;
                out.textContent = '';
                out.style.display = 'none';
                if (status) {
                    status.style.display = 'block';
                    status.textContent = 'Generando sugerencias...';
                }

                try {
                    const resp = await fetch("{% url 'cba_ai_suggest_scores' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({})
                    });
                    const data = await resp.json();
                    if (!data.ok) {
                        throw new Error(data.error || 'No se pudieron generar sugerencias.');
                    }

                    const suggestions = Array.isArray(data.suggestions) ? data.suggestions : [];
                    if (suggestions.length === 0) {
                        throw new Error('No hay sugerencias.');
                    }

                    // Autocompletar los inputs (sin mostrar listado en pantalla).
                    suggestions.forEach(s => {
                        const field = s.field;
                        const val = s.suggested_value;

                        const input = document.querySelector('input[name="' + field + '"]');
                        if (input) {
                            input.value = String(val);
                        }
                    });

                    // Al cambiar valores, invalidar el último reporte guardado.
                    try { window.localStorage.removeItem(AUDIT_STORAGE_KEY); } catch (e) {}

                    if (status) {
                        status.textContent = 'Listo.';
                        window.setTimeout(() => {
                            status.style.display = 'none';
                            status.textContent = '';
                        }, 1200);
                    }
                } catch (e) {
                    out.textContent = '';
                    if (status) status.textContent = (e && e.message) ? e.message : 'Error generando sugerencias.';
                } finally {
                    btn.disabled = false;
                }
            });
        })();

        (function initAIAuditScores(){
            const STORAGE_KEY = 'cba_step8_ai_puntajes_v1';
            const btn = document.getElementById('aiAuditScoresBtn');
            const out = document.getElementById('aiSuggestScoresOutput');
            const status = document.getElementById('aiSuggestScoresStatus');
            if (!btn || !out) return;

            // Restaurar último texto al volver a la página
            try {
                const cached = window.localStorage.getItem(STORAGE_KEY);
                if (cached) {
                    out.innerHTML = cached;
                    out.style.display = 'block';
                    if (status) {
                        status.style.display = 'block';
                        status.textContent = 'Última revisión cargada.';
                    }
                }
            } catch (e) {
                // no-op
            }

            // Si el usuario cambia puntajes o avanza, invalidar la respuesta guardada
            const formEl = document.querySelector('form[method="post"]');
            if (formEl) {
                formEl.addEventListener('submit', () => {
                    try { window.localStorage.removeItem(STORAGE_KEY); } catch (e) {}
                }, { capture: true });
            }
            document.querySelectorAll('input[type="number"][name^="imp_"]').forEach((inp) => {
                inp.addEventListener('input', () => {
                    try { window.localStorage.removeItem(STORAGE_KEY); } catch (e) {}
                }, { passive: true });
            });

            btn.addEventListener('click', async () => {
                btn.disabled = true;
                if (status) {
                    status.style.display = 'block';
                    status.textContent = 'Detectando inconsistencias de puntajes...';
                }
                out.style.display = 'block';
                out.textContent = '';

                try {
                    const inputs = Array.from(document.querySelectorAll('input[type="number"][name^="imp_"]'));
                    const scores = {};
                    inputs.forEach(inp => {
                        scores[inp.name] = inp.value;
                    });

                    const resp = await fetch("{% url 'cba_ai_scores_audit' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ scores })
                    });

                    const data = await resp.json();
                    if (!data.ok) {
                        throw new Error(data.error || 'No se pudo auditar puntajes.');
                    }

                    out.innerHTML = renderAIMarkup(data.content || '');
                    try { window.localStorage.setItem(STORAGE_KEY, out.innerHTML); } catch (e) {}
                    if (status) status.textContent = 'Listo.';
                } catch (e) {
                    out.textContent = '';
                    if (status) status.textContent = (e && e.message) ? e.message : 'Error auditando puntajes.';
                } finally {
                    btn.disabled = false;
                }
            });
        })();
    </script>
{% endblock %}

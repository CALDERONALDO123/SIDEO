{% extends "cba_app/base.html" %}

{% block body_class %}page-step page-step3{% endblock %}

{% block content %}
    <div class="dashboard-panel step-panel">
        <div class="step-head">
            <div class="step-head__main">
                <p class="step-head__eyebrow">CBA · Paso 3</p>
                <h2 class="step-head__title">MUST / WANT</h2>
                <p class="step-head__lede">Marca cada factor como indispensable o deseable, y agrega un comentario breve si aplica.</p>
                {% include "cba_app/_step_progress.html" with current=3 total=10 percent=30 %}
            </div>
        </div>

        {% include "cba_app/_cba_context_bar.html" %}

        <section class="assistant" aria-label="Asistente IA">
            <div class="assistant__head">
                <div class="assistant__meta">
                    <div class="assistant__title">Asistente SIDEO IA</div>
                    <div class="assistant__subtitle">Revisa si tu distribución MUST/WANT tiene sentido y si faltan comentarios.</div>
                </div>
                <div class="assistant__actions">
                    <button type="button" class="button" id="aiTypeAuditBtn">Revisar MUST/WANT</button>
                    <button type="button" class="button button--ghost" id="aiTypeAuditClearBtn">Limpiar</button>
                </div>
            </div>

            <div id="aiTypeAuditStatus" class="cba-ai__status text-muted" style="display:none;"></div>

            <div class="assistant__body">
                <div id="aiTypeAuditPlaceholder" class="assistant__placeholder">Aquí aparecerá la respuesta del asistente.</div>
                <pre id="aiTypeAuditOutput" class="cba-ai__output" aria-label="Respuesta del asistente IA"></pre>
            </div>
        </section>

        <form method="post">
            {% csrf_token %}

            <div class="table-wrapper table-wrapper--step" style="margin-top:16px;">
            <table>
                <tr>
                    <th>Factor</th>
                    <th>Indispensable</th>
                    <th>Deseable</th>
                    <th>Explicación / comentario</th>
                </tr>
                {% for c in criteria %}
                <tr>
                    <td>{{ c.name }}</td>
                    <td style="text-align: center;">
                        <input type="radio" name="type_{{ c.id }}" value="{{ c.TYPE_MUST }}" {% if c.criterion_type == c.TYPE_MUST %}checked{% endif %}>
                    </td>
                    <td style="text-align: center;">
                        <input type="radio" name="type_{{ c.id }}" value="{{ c.TYPE_WANT }}" {% if c.criterion_type == c.TYPE_WANT %}checked{% endif %}>
                    </td>
                    <td>
                        <textarea name="desc_{{ c.id }}" rows="2" cols="40">{{ c.description }}</textarea>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4">No hay factores/criterios registrados aún.</td>
                </tr>
                {% endfor %}
            </table>
            </div>

            <div class="step-nav">
                <a href="{% url 'cba_step2' %}" class="link-back nav-prev">&larr; Paso anterior</a>
                <button type="submit" class="button nav-next">Guardar y continuar &rsaquo;</button>
            </div>
        </form>
    </div>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function renderAIMarkup(text) {
            let safe = escapeHtml(text || '');
            safe = safe.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            return safe;
        }

        (function initTypeAudit(){
            const STORAGE_KEY = 'cba_step3_ai_mustwant_v1';
            const btn = document.getElementById('aiTypeAuditBtn');
            const clearBtn = document.getElementById('aiTypeAuditClearBtn');
            const out = document.getElementById('aiTypeAuditOutput');
            const status = document.getElementById('aiTypeAuditStatus');
            const placeholder = document.getElementById('aiTypeAuditPlaceholder');
            if (!btn || !out) return;

            out.textContent = '';
            if (placeholder) placeholder.style.display = 'block';

            // Restaurar último texto al volver a la página
            try {
                const cached = window.localStorage.getItem(STORAGE_KEY);
                if (cached) {
                    out.innerHTML = cached;
                    if (placeholder) placeholder.style.display = 'none';
                    if (status) {
                        status.style.display = 'block';
                        status.textContent = 'Última revisión cargada.';
                    }
                }
            } catch (e) {
                // no-op
            }

            // Limpiar cache al guardar cambios del Paso 3
            document.querySelectorAll('form').forEach((formEl) => {
                formEl.addEventListener('submit', () => {
                    try { window.localStorage.removeItem(STORAGE_KEY); } catch (e) {}
                });
            });

            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    out.textContent = '';
                    if (placeholder) placeholder.style.display = 'block';
                    if (status) {
                        status.style.display = 'block';
                        status.textContent = 'Limpio.';
                    }
                    try { window.localStorage.removeItem(STORAGE_KEY); } catch (e) {}
                });
            }

            btn.addEventListener('click', async () => {
                btn.disabled = true;
                if (status) {
                    status.style.display = 'block';
                    status.textContent = 'Revisando MUST/WANT...';
                }
                if (placeholder) placeholder.style.display = 'none';
                out.textContent = '';

                try {
                    const resp = await fetch("{% url 'cba_ai_criteria_type_audit' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({})
                    });
                    const data = await resp.json();
                    if (!data.ok) {
                        throw new Error(data.error || 'No se pudo auditar MUST/WANT.');
                    }
                    out.innerHTML = renderAIMarkup(data.content || '');
                    try { window.localStorage.setItem(STORAGE_KEY, out.innerHTML); } catch (e) {}
                    if (status) status.textContent = 'Listo.';
                } catch (e) {
                    out.textContent = '';
                    if (placeholder) placeholder.style.display = 'block';
                    if (status) status.textContent = (e && e.message) ? e.message : 'Error auditando MUST/WANT.';
                } finally {
                    btn.disabled = false;
                }
            });
        })();
    </script>
{% endblock %}

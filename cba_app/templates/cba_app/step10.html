{% extends "cba_app/base.html" %}

{% block body_class %}page-step page-step10{% endblock %}

{% block content %}
    <section class="content pt-3">
        <div class="container-fluid">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex flex-column">
                        <div class="text-muted text-uppercase text-sm">CBA · Paso 10</div>
                        <h3 class="m-0">Costo versus ventaja</h3>
                        <div class="text-muted text-sm mt-2">Compara alternativas por costo y total de ventajas para obtener un ganador.</div>
                    </div>
                    <div class="mt-2">
                        {% include "cba_app/_step_progress.html" with current=10 total=10 percent=100 %}
                    </div>
                </div>

                <div class="card-body">

    {% include "cba_app/_cba_context_bar.html" %}

    <p class="text-muted">En este paso se comparan las alternativas considerando el costo y el total de ventajas. La alternativa ganadora es la que logra el <strong>menor costo por cada punto de ventaja</strong>.</p>

    <div style="margin-top:16px;">
        <div class="cba-ai__actions">
            <button type="button" class="btn btn-primary btn-sm" id="aiCostAuditBtn">Revisar costos (IA)</button>
        </div>
        <div id="aiCostAuditStatus" class="cba-ai__status text-muted" style="margin-top:8px; display:none;"></div>
        <pre id="aiCostAuditOutput" class="cba-ai__output" aria-label="Salida auditor IA costos"></pre>
    </div>

    <form method="post">
        {% csrf_token %}

        <div class="table-wrapper table-wrapper--step" style="margin-top:16px;">
        <div class="table-responsive">
        <table class="table table-bordered table-striped table-sm mb-0">
            <tr>
                <th>Alternativa</th>
                <th>Total de ventajas</th>
                <th>Costo (S/)</th>
                <th>Costo / Ventaja (S/ por punto)</th>
            </tr>
            {% for row in rows %}
            <tr class="{% if best_row and row.alternative.id == best_row.alternative.id %}table-success font-weight-bold{% endif %}">
                <td>{{ row.alternative.name }}</td>
                <td>{{ row.total_importance }}</td>
                <td>
                    <input type="number" step="0.01" class="form-control form-control-sm" name="cost_{{ row.alternative.id }}" value="{% if row.cost %}{{ row.cost }}{% endif %}">
                </td>
                <td>
                    {% if row.ratio is not None %}
                        S/ {{ row.ratio|floatformat:4 }}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4">No hay datos suficientes aún.</td>
            </tr>
            {% endfor %}
        </table>
        </div>

        <div style="margin-top:16px; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
            <button type="submit" name="save_recalc" class="btn btn-primary">Guardar costos y recalcular</button>
        </div>

        <hr>

        <h2>Gráfico costo vs. total de ventajas</h2>
        <p>
            Pulsa el botón "Graficar" para dibujar, desde el origen (0,0),
            una recta hasta cada punto (Costo, Total de ventajas) de las alternativas.
        </p>

        <button type="button" class="btn btn-outline-secondary" onclick="drawChart()">Graficar</button>

        <br><br>
        <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
            <div class="cba-chartwrap" style="flex:1 1 640px; min-width:280px;">
                <canvas id="cbaChart" width="640" height="400" style="border:1px solid #e5e7eb; background:#ffffff; max-width:100%; height:auto;"></canvas>
                <div id="cbaTooltip" class="cba-tooltip" role="status" aria-live="polite"></div>
            </div>
            <div id="cbaLegend" style="font-size:13px; color:#374151; flex:0 1 240px; min-width:200px; max-width:100%; word-break:break-word;"></div>
        </div>

        <div style="margin-top:16px; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
            <button type="submit" name="save_to_dashboard" class="btn btn-primary">Guardar e ir a Dashboard</button>
        </div>
    </form>

    <div class="step-nav d-flex justify-content-between flex-wrap">
        <a href="{% url 'cba_step9' %}" class="btn btn-outline-secondary nav-prev">&larr; Paso anterior</a>
    </div>

                </div>
            </div>
        </div>
    </section>

{% endblock %}

{% block extra_js %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function escapeHtml(str) {
        return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
    }

    function renderAIMarkup(text) {
        let safe = escapeHtml(text || '');
        safe = safe.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        return safe;
    }

    (function () {
        const chartData = JSON.parse("{{ chart_data_json|escapejs }}");

        function drawChart() {
            const legendContainer = document.getElementById('cbaLegend');

            if (window.SIDEO && SIDEO.charts) {
                SIDEO.charts.renderCostBenefitScatter('cbaChart', chartData, {
                    xLabel: 'Costo (S/)',
                    yLabel: 'Total de ventajas',
                    legendContainer: legendContainer,
                    tooltipElement: document.getElementById('cbaTooltip'),
                    tooltipTrigger: 'hover-line',
                });
                return;
            }
        }

        // Mantener el onclick existente
        window.drawChart = drawChart;

        document.addEventListener('DOMContentLoaded', function () {
            const STORAGE_KEY = 'cba_step10_ai_costos_v1';
            const btn = document.getElementById('aiCostAuditBtn');
            const out = document.getElementById('aiCostAuditOutput');
            const status = document.getElementById('aiCostAuditStatus');
            const formEl = document.querySelector('form[method="post"]');

            if (!btn || !out) return;

            // Restaurar último texto al volver a la página
            try {
                const cached = window.localStorage.getItem(STORAGE_KEY);
                if (cached) {
                    out.innerHTML = cached;
                    if (status) {
                        status.style.display = 'block';
                        status.textContent = 'Última revisión cargada.';
                    }
                }
            } catch (e) {
                // no-op
            }

            function invalidateCache() {
                try { window.localStorage.removeItem(STORAGE_KEY); } catch (e) {}
            }

            if (formEl) {
                formEl.addEventListener('submit', invalidateCache, { capture: true });
            }

            document.querySelectorAll('input[name^="cost_"]').forEach((inp) => {
                inp.addEventListener('input', invalidateCache, { passive: true });
            });

            function buildPayload() {
                const rows = Array.from(document.querySelectorAll('table tr')).slice(1);
                const items = [];
                rows.forEach(function (tr) {
                    const tds = tr.querySelectorAll('td');
                    if (tds.length < 3) return;
                    const name = (tds[0].textContent || '').trim();
                    const total = (tds[1].textContent || '').trim();
                    const input = tds[2].querySelector('input[name^="cost_"]');
                    const cost = input ? input.value : '';
                    if (!name) return;
                    items.push({ name: name, total: total, cost: cost });
                });
                return { items: items };
            }

            btn.addEventListener('click', async () => {
                btn.disabled = true;
                if (status) {
                    status.style.display = 'block';
                    status.textContent = 'Revisando costos...';
                }
                out.textContent = '';

                try {
                    const resp = await fetch("{% url 'cba_ai_costs_audit' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(buildPayload())
                    });

                    const data = await resp.json();
                    if (!data.ok) {
                        throw new Error(data.error || 'No se pudo auditar costos.');
                    }

                    out.innerHTML = renderAIMarkup(data.content || '');
                    try { window.localStorage.setItem(STORAGE_KEY, out.innerHTML); } catch (e) {}
                    if (status) status.textContent = 'Listo.';
                } catch (e) {
                    out.textContent = '';
                    if (status) status.textContent = (e && e.message) ? e.message : 'Error auditando costos.';
                } finally {
                    btn.disabled = false;
                }
            });
        });

        window.addEventListener('resize', (window.SIDEO && SIDEO.utils) ? SIDEO.utils.debounce(drawChart, 150) : drawChart);
    })();
</script>
{% endblock %}

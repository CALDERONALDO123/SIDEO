{% extends "cba_app/base.html" %}

{% block content %}
    <h2>Archivos guardados (resultados CBA)</h2>

    <div class="table-wrapper">
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-bottom:12px;">
            <div style="min-width:220px;">
                <div style="font-size:12px; color:#4b5563; margin-bottom:4px;">Buscar (nombre)</div>
                <input type="text" id="filterName" placeholder="Ej. CBA - Proyecto X" style="width:100%;" />
            </div>
            <div>
                <div style="font-size:12px; color:#4b5563; margin-bottom:4px;">Desde (fecha)</div>
                <input type="date" id="filterDateFrom" />
            </div>
            <div>
                <div style="font-size:12px; color:#4b5563; margin-bottom:4px;">Hasta (fecha)</div>
                <input type="date" id="filterDateTo" />
            </div>
            <div>
                <div style="font-size:12px; color:#4b5563; margin-bottom:4px;">Costo m√≠n.</div>
                <input type="number" id="filterCostMin" step="0.01" placeholder="0" style="width:120px;" />
            </div>
            <div>
                <div style="font-size:12px; color:#4b5563; margin-bottom:4px;">Costo m√°x.</div>
                <input type="number" id="filterCostMax" step="0.01" placeholder="" style="width:120px;" />
            </div>
            <div>
                <button type="button" class="button" id="filterResetBtn">Limpiar</button>
            </div>
        </div>

            <table>
            <tr>
                <th>Nombre</th>
                <th>Fecha</th>
                <th>Ganador</th>
                <th>Total de ventajas</th>
                <th>Costo</th>
                <th>Costo / Ventaja (S/ por punto)</th>
                <th style="width:110px; text-align:center;">Acciones</th>
            </tr>
            {% for r in results %}
            <tr data-row="result"
                data-name="{{ r.name|default_if_none:'' }}"
                data-date="{{ r.created_at|date:'Y-m-d' }}"
                data-cost="{% if r.winner_cost %}{{ r.winner_cost }}{% endif %}">
                <td>{{ r.name }}</td>
                <td>{{ r.created_at|date:"Y-m-d H:i" }}</td>
                <td>{{ r.winner_name }}</td>
                <td>{{ r.winner_total }}</td>
                <td>{% if r.winner_cost %}{{ r.winner_cost }}{% else %}-{% endif %}</td>
                <td>{% if r.winner_ratio is not None %}S/ {{ r.winner_ratio|floatformat:4 }}{% else %}-{% endif %}</td>
                <td style="text-align:center;">
                    <div class="table-actions" aria-label="Acciones">
                        <a class="table-action table-action--view" href="{% url 'cba_saved_result_detail' r.id %}" title="Ver" aria-label="Ver">
                            <span class="table-action__icon" aria-hidden="true">üëÅ</span>
                            <span class="table-action__text">Ver</span>
                        </a>
                        <form method="post" action="{% url 'cba_saved_result_delete' r.id %}" style="display:inline; margin:0;">
                            {% csrf_token %}
                            <button type="submit" class="table-action table-action--delete" title="Eliminar" aria-label="Eliminar">
                                <span class="table-action__icon" aria-hidden="true">&times;</span>
                                <span class="table-action__text">Eliminar</span>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr id="serverEmptyRow">
                <td colspan="7">No hay resultados guardados todav√≠a.</td>
            </tr>
            {% endfor %}
            <tr id="noMatchesRow" style="display:none;">
                <td colspan="7">No hay coincidencias con los filtros.</td>
            </tr>
                </table>
            </div>

            <script>
        (function initSavedResultsFilters(){
            const nameEl = document.getElementById('filterName');
            const dateFromEl = document.getElementById('filterDateFrom');
            const dateToEl = document.getElementById('filterDateTo');
            const costMinEl = document.getElementById('filterCostMin');
            const costMaxEl = document.getElementById('filterCostMax');
            const resetBtn = document.getElementById('filterResetBtn');
            const noMatchesRow = document.getElementById('noMatchesRow');
            const serverEmptyRow = document.getElementById('serverEmptyRow');

            const rows = Array.from(document.querySelectorAll('tr[data-row="result"]'));
            if (rows.length === 0) return;

            function toNum(v) {
                if (v === null || v === undefined) return null;
                const s = String(v).trim();
                if (!s) return null;
                const n = Number(s);
                return Number.isFinite(n) ? n : null;
            }

            function applyFilters() {
                const q = (nameEl?.value || '').trim().toLowerCase();
                const df = (dateFromEl?.value || '').trim();
                const dt = (dateToEl?.value || '').trim();
                const cmin = toNum(costMinEl?.value);
                const cmax = toNum(costMaxEl?.value);

                let visibleCount = 0;
                rows.forEach(tr => {
                    const n = String(tr.dataset.name || '').toLowerCase();
                    const d = String(tr.dataset.date || '');
                    const c = toNum(tr.dataset.cost);

                    let ok = true;
                    if (q && !n.includes(q)) ok = false;
                    if (ok && df && d && d < df) ok = false;
                    if (ok && dt && d && d > dt) ok = false;
                    if (ok && cmin !== null) {
                        if (c === null || c < cmin) ok = false;
                    }
                    if (ok && cmax !== null) {
                        if (c === null || c > cmax) ok = false;
                    }

                    tr.style.display = ok ? '' : 'none';
                    if (ok) visibleCount += 1;
                });

                if (serverEmptyRow) serverEmptyRow.style.display = 'none';
                if (noMatchesRow) noMatchesRow.style.display = (visibleCount === 0) ? '' : 'none';
            }

            function reset() {
                if (nameEl) nameEl.value = '';
                if (dateFromEl) dateFromEl.value = '';
                if (dateToEl) dateToEl.value = '';
                if (costMinEl) costMinEl.value = '';
                if (costMaxEl) costMaxEl.value = '';
                applyFilters();
            }

            [nameEl, dateFromEl, dateToEl, costMinEl, costMaxEl].forEach(el => {
                if (!el) return;
                el.addEventListener('input', applyFilters);
                el.addEventListener('change', applyFilters);
            });
            if (resetBtn) resetBtn.addEventListener('click', reset);

            applyFilters();
        })();
    </script>
{% endblock %}
